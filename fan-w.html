<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FanCode Live</title>
  <script src="https://cdn.jwplayer.com/libraries/aVr2lJgW.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0d1117; color:white; font-family:Inter, sans-serif; }
    .jwplayer { border-radius:12px; overflow:hidden; }
    .switch-btn {
      @apply px-4 py-2 rounded-lg font-semibold shadow-md;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

  <!-- Title -->
  <h1 id="matchTitle" class="text-2xl font-bold text-blue-400 mb-4 text-center">Loading...</h1>

  <!-- Player -->
  <div id="player" class="w-full max-w-3xl aspect-video rounded-2xl overflow-hidden shadow-lg"></div>

  <!-- Controls -->
  <div class="mt-4 flex gap-3 flex-wrap justify-center">
    <button id="cloudfrontBtn" class="switch-btn bg-blue-600 hover:bg-blue-700">Main (CloudFront)</button>
    <button id="adfreeBtn" class="switch-btn bg-gray-600 hover:bg-gray-700">Fallback (Ad-Free)</button>
    <button id="daiBtn" class="switch-btn bg-gray-800 hover:bg-gray-900">Fallback (DAI)</button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const matchId = urlParams.get("id");

    const apiUrl = "https://goodproxy.eren-yeager-founding-titan-9.workers.dev/fetch?url=" +
      encodeURIComponent("https://raw.githubusercontent.com/jitendra-unatti/fancode/refs/heads/main/data/fancode.json");

    let currentMatch = null;
    let playerInstance = null;

    let cloudfrontUrl = "";
    let adfreeUrl = "";
    let daiUrl = "";

    async function loadMatch() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();

        currentMatch = data.find(m => m.id == matchId);
        if (!currentMatch) {
          document.getElementById("matchTitle").textContent = "Match not found!";
          return;
        }

        document.getElementById("matchTitle").textContent = currentMatch.name;

        // Assign URLs
        cloudfrontUrl = currentMatch.cloudfront_cdn || "";
        adfreeUrl = currentMatch.adfree_url || "";

        // Build daiUrl from adfreeUrl
        if (adfreeUrl) {
          try {
            const urlObj = new URL(adfreeUrl);
            const pathPart = urlObj.pathname; 
            daiUrl = "https://dai.fancode.com/primary" + pathPart;
          } catch (e) {
            console.error("DAI URL build failed:", e);
          }
        }

        // Init JWPlayer with CloudFront by default
        if (cloudfrontUrl) {
          setupPlayer(cloudfrontUrl);
        } else if (adfreeUrl) {
          setupPlayer(adfreeUrl);
        } else {
          document.getElementById("matchTitle").textContent = "No stream available!";
        }

      } catch (err) {
        console.error("Error loading match:", err);
      }
    }

    function setupPlayer(url) {
      playerInstance = jwplayer("player").setup({
        file: url,
        image: currentMatch.image || "",
        width: "100%",
        aspectratio: "16:9",
        autostart: true,
        skin: { name: "seven" }
      });
    }

    function switchSource(url) {
      if (!url || !playerInstance) return;
      playerInstance.load([{ file: url }]);
      playerInstance.play();
    }

    document.getElementById("cloudfrontBtn").addEventListener("click", () => switchSource(cloudfrontUrl));
    document.getElementById("adfreeBtn").addEventListener("click", () => switchSource(adfreeUrl));
    document.getElementById("daiBtn").addEventListener("click", () => switchSource(daiUrl));

    loadMatch();
  </script>
</body>
</html>
