<script type="module">
  const urlParams = new URLSearchParams(window.location.search);
  const matchId = urlParams.get("id");

  const apiUrl = "https://crew-auth.vercel.app/fancode";

  let currentMatch = null;
  let player = null;

  let cloudfrontUrl = "";
  let adfreeUrl = "";
  let daiUrl = "";
  let currentVideoUrl = "";

  async function loadMatch() {
    try {
      // Fetch as text first
      const res = await fetch(apiUrl, {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36'
        }
      });
      
      if (!res.ok) throw new Error(`Failed to fetch data: ${res.status}`);
      
      let text = await res.text();
      
      // Repair the JSON dynamically
      let data = [];
      try {
        // Using jsonrepair (assuming it's available globally or via ESM)
        data = JSON.parse(jsonrepair(text));
      } catch (err) {
        console.warn("JSON repair failed, trying raw parse...", err);
        try {
          data = JSON.parse(text); // fallback attempt
        } catch {
          document.getElementById("matchTitle").textContent = "Match data malformed!";
          return;
        }
      }

      currentMatch = data.find(m => m.id == matchId);
      if (!currentMatch) {
        document.getElementById("matchTitle").textContent = "Match not found!";
        return;
      }

      document.getElementById("matchTitle").textContent = currentMatch.name;

      // Set main and fallbacks
      cloudfrontUrl = currentMatch.cloudfront_cdn || "";
      adfreeUrl = currentMatch.adfree_url || "";
      daiUrl = adfreeUrl ? "https://dai.fancode.com/primary" + new URL(adfreeUrl).pathname : "";

      // Determine the starting URL and disable buttons for missing URLs
      const startUrl = cloudfrontUrl || adfreeUrl || daiUrl;
      const startSource = cloudfrontUrl ? "cloudfront" : (adfreeUrl ? "adfree" : "dai");

      if (!cloudfrontUrl) document.getElementById("cloudfrontBtn").disabled = true;
      if (!adfreeUrl) document.getElementById("adfreeBtn").disabled = true;
      if (!daiUrl) document.getElementById("daiBtn").disabled = true;

      if (!startUrl) {
        document.getElementById("matchTitle").textContent = "No stream found for this match.";
        return;
      }
      
      currentVideoUrl = startUrl;

      // Initialize player with the starting URL
      player = videojs("videoPlayer", {
        controls: true,
        autoplay: true,
        preload: "auto",
        fluid: true,
        sources: [{ src: startUrl, type: "application/x-mpegURL" }]
      });
      
      highlightActiveButton(startSource);
      updateUrlInput(startUrl);

    } catch (err) {
      console.error("Error loading match:", err);
      document.getElementById("matchTitle").textContent = "Error loading match data. Please try again later.";
    }
  }

  function highlightActiveButton(source) {
    const buttons = document.querySelectorAll('.switch-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(source + 'Btn');
    if (activeBtn) activeBtn.classList.add('active');
  }

  function updateUrlInput(url) {
    const urlInput = document.getElementById('currentUrlInput');
    urlInput.value = url;
  }

  function switchSource(url, source) {
    if (!url || !player) return;
    currentVideoUrl = url;

    player.src({ src: url, type: "application/x-mpegURL" });
    player.play();
    highlightActiveButton(source);
    updateUrlInput(url);
  }

  document.getElementById("cloudfrontBtn").addEventListener("click", () => switchSource(cloudfrontUrl, "cloudfront"));
  document.getElementById("adfreeBtn").addEventListener("click", () => switchSource(adfreeUrl, "adfree"));
  document.getElementById("daiBtn").addEventListener("click", () => switchSource(daiUrl, "dai"));

  document.getElementById("copyUrlBtn").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(currentVideoUrl);
      alert("URL copied to clipboard!");
    } catch (err) {
      console.error("Failed to copy URL:", err);
      alert("Failed to copy URL. Please copy it manually.");
    }
  });

  loadMatch();
</script>
