<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FanCode Live</title>

  <!-- Video.js -->
  <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#0d1117; color:white; font-family:Inter, sans-serif; }
    .video-js { border-radius:12px; overflow:hidden; }
    .vjs-theme-blue .vjs-control-bar {
      background: rgba(0, 122, 255, 0.9);
    }
    .switch-btn {
      @apply px-4 py-2 rounded-lg font-semibold shadow-md;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

  <!-- Title -->
  <h1 id="matchTitle" class="text-2xl font-bold text-blue-400 mb-4 text-center">Loading...</h1>

  <!-- Player -->
  <video id="videoPlayer" class="video-js vjs-theme-blue w-full max-w-3xl rounded-2xl shadow-lg" controls preload="auto" playsinline></video>

  <!-- Controls -->
  <div class="mt-4 flex gap-3 flex-wrap justify-center">
    <button id="cloudfrontBtn" class="switch-btn bg-blue-600 hover:bg-blue-700">Main (CloudFront)</button>
    <button id="adfreeBtn" class="switch-btn bg-gray-600 hover:bg-gray-700">Fallback (Ad-Free)</button>
    <button id="daiBtn" class="switch-btn bg-gray-800 hover:bg-gray-900">Fallback (DAI)</button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const matchId = urlParams.get("id");

    const apiUrl = "https://goodproxy.eren-yeager-founding-titan-9.workers.dev/fetch?url=" +
      encodeURIComponent("https://raw.githubusercontent.com/jitendra-unatti/fancode/refs/heads/main/data/fancode.json");

    let currentMatch = null;
    let player = null;

    let cloudfrontUrl = "";
    let adfreeUrl = "";
    let daiUrl = "";

    async function loadMatch() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();

        currentMatch = data.find(m => m.id == matchId);
        if (!currentMatch) {
          document.getElementById("matchTitle").textContent = "Match not found!";
          return;
        }

        document.getElementById("matchTitle").textContent = currentMatch.name;

        // Set main + fallbacks
        cloudfrontUrl = currentMatch.cloudfront_cdn || "";
        adfreeUrl = currentMatch.adfree_url || "";

        // Build daiUrl from adfreeUrl
        if (adfreeUrl) {
          try {
            const urlObj = new URL(adfreeUrl);
            const pathPart = urlObj.pathname;
            daiUrl = "https://dai.fancode.com/primary" + pathPart;
          } catch (e) {
            console.error("DAI URL build failed:", e);
          }
        }

        // Init Video.js with main (cloudfront or fallback)
        let startUrl = cloudfrontUrl || adfreeUrl || daiUrl;
        player = videojs("videoPlayer", {
          controls: true,
          autoplay: true,
          preload: "auto",
          fluid: true,
          sources: [{ src: startUrl, type: "application/x-mpegURL" }]
        });

      } catch (err) {
        console.error("Error loading match:", err);
      }
    }

    function switchSource(url) {
      if (!url || !player) return;
      player.src({ src: url, type: "application/x-mpegURL" });
      player.play();
    }

    document.getElementById("cloudfrontBtn").addEventListener("click", () => switchSource(cloudfrontUrl));
    document.getElementById("adfreeBtn").addEventListener("click", () => switchSource(adfreeUrl));
    document.getElementById("daiBtn").addEventListener("click", () => switchSource(daiUrl));

    loadMatch();
  </script>
</body>
</html>
