<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hanime Player</title>
<script src="https://cdn.jwplayer.com/libraries/aVr2lJgW.js"></script>
<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #player { width: 100%; flex: 1; }
  .storyboards {
    display: flex;
    overflow-x: auto;
    padding: 10px;
    background: #111;
  }
  .storyboards img {
    margin-right: 5px;
    height: 90px;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .storyboards img:hover { transform: scale(1.1); }
</style>
</head>
<body>

<div id="player"></div>
<div class="storyboards" id="storyboards"></div>

<script>
async function fetchVideoStreams(slug) {
  const res = await fetch(`https://hanime.tv/api/v8/video?id=${slug}`);
  const data = await res.json();
  const streams = data.videos_manifest.servers[0].streams
    .filter(s => s.url)  // only streams with URLs
    .map(s => ({ file: s.url, label: `${s.height}p`, type: "hls" }));
  return { streams, videoId: data.hentai_video.id };
}

async function fetchStoryboards(videoId) {
  const res = await fetch(`https://hanime.tv/rapi/v7/hentai_video_storyboards?hv_id=${videoId}`);
  const data = await res.json();
  return data.hentai_video_storyboards[0];
}

async function initPlayer() {
  // Get slug from URL hash
  const slug = location.hash.slice(1);
  if (!slug) {
    alert("No video ID in URL hash!");
    return;
  }

  const { streams, videoId } = await fetchVideoStreams(slug);
  const storyboardData = await fetchStoryboards(videoId);

  // Setup JWPlayer
  jwplayer("player").setup({
    sources: streams,
    width: "100%",
    height: "100%",
    aspectratio: "16:9",
    autostart: false,
    skin: { name: "storm" },
    stretching: "uniform"
  });

  // Render storyboards
  const container = document.getElementById("storyboards");
  const framesPerRow = storyboardData.num_horizontal_frames;
  const frameWidth = storyboardData.frame_width;
  const frameHeight = storyboardData.frame_height;
  const totalFrames = storyboardData.num_total_frames;

  for (let i = 0; i < totalFrames; i++) {
    const img = document.createElement("img");
    img.src = storyboardData.url;
    img.alt = `Frame ${i + 1}`;
    img.width = frameWidth;
    img.height = frameHeight;
    img.onclick = () => {
      const duration = jwplayer("player").getDuration() || 0;
      jwplayer("player").seek((i / totalFrames) * duration);
    };
    container.appendChild(img);
  }
}

window.addEventListener("hashchange", initPlayer);
initPlayer();
</script>

</body>
</html>
